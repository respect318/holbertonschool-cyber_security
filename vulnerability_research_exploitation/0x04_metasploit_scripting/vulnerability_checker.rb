##
# MS17-010 Vulnerability Checker
##

require 'msf/core'

class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::SMB::Client
  include Msf::Auxiliary::Scanner

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name'        => 'MS17-010 Vulnerability Checker',
        'Description' => 'Checks if a target is vulnerable to MS17-010 (EternalBlue)',
        'Author'      => ['Farid Mirzazada'],
        'License'     => MSF_LICENSE
      )
    )

    register_options(
      [
        Opt::RHOST()
      ]
    )
  end

  def run_host(ip)
    print_status("Checking #{ip} for MS17-010 vulnerability")

    begin
      connect
      smb_login

      # Send a TRANS2 request (classic MS17-010 detection logic)
      pkt = Rex::Proto::SMB::Constants::SMB_COM_TRANSACTION2
      response = simple.client.trans2(pkt)

      if response && response.status == 0xC0000205
        print_good("#{ip} is vulnerable to MS17-010.")
      else
        print_status("#{ip} is NOT vulnerable to MS17-010.")
      end

    rescue ::Rex::ConnectionError
      print_error("Connection failed to #{ip}")
    rescue ::Exception => e
      print_error("Error checking #{ip}: #{e.message}")
    ensure
      disconnect
    end
  end
end
